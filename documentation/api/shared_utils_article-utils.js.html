<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: shared/utils/article-utils.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: shared/utils/article-utils.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Shared article manipulation utilities

/**
 * Determine read status and read date from existing and new article data
 * 
 * Logic priority:
 * 1. If newArticle explicitly sets isRead: use it and set readDate accordingly
 * 2. If existing article exists: preserve its read status
 * 3. Otherwise: use newArticle defaults (typically false)
 * 
 * @param {Object|null} existing - Existing article from storage (may be null)
 * @param {Object} newArticle - New article data being saved
 * @returns {{isRead: boolean, readDate: string|null}} Object with isRead and readDate
 */
function determineReadStatus(existing, newArticle) {
  // Runtime type validation
  if (existing != null &amp;&amp; (typeof existing !== 'object' || Array.isArray(existing))) {
    Logger.warn('determineReadStatus: existing must be an object or null', existing);
    existing = null;
  }
  
  if (!newArticle || typeof newArticle !== 'object' || Array.isArray(newArticle)) {
    Logger.warn('determineReadStatus: newArticle must be an object', newArticle);
    return { isRead: false, readDate: null };
  }
  // If new article explicitly sets isRead property
  if (newArticle.hasOwnProperty('isRead')) {
    const isRead = newArticle.isRead || false;
    // If readDate is explicitly provided, use it; otherwise set current date if marking as read
    const readDate = newArticle.readDate !== undefined 
      ? newArticle.readDate 
      : (isRead ? new Date().toISOString() : null);
    return { isRead, readDate };
  }
  
  // If existing article exists, preserve its read status
  if (existing) {
    return {
      isRead: existing.isRead || false,
      readDate: existing.readDate || null
    };
  }
  
  // Default: not read
  return {
    isRead: newArticle.isRead || false,
    readDate: newArticle.readDate || null
  };
}

/**
 * Merge article state preserving existing read status
 * Used for syncing and saving articles from page extraction
 * @param {Object|null} existing - Existing article
 * @param {Object} newArticle - New article data
 * @returns {Object} Merged article with normalized URL
 */
function mergeArticleState(existing, newArticle) {
  if (!existing) {
    return {
      url: normalizeUrl(newArticle.url),
      title: newArticle.title || '',
      publishedDate: newArticle.publishedDate || '',
      dateText: newArticle.dateText || newArticle.publishedDate || '',
      isRead: newArticle.isRead || false,
      readDate: newArticle.readDate || null
    };
  }
  
  return {
    url: existing.url || normalizeUrl(newArticle.url),
    title: newArticle.title || existing.title || '',
    publishedDate: newArticle.publishedDate || existing.publishedDate || '',
    dateText: newArticle.dateText || newArticle.publishedDate || existing.dateText || '',
    isRead: existing.isRead || false,
    readDate: existing.readDate || null
  };
}

/**
 * Merge article data keeping most recent read date (for import)
 * 
 * Import strategy:
 * - Only imports articles marked as read (isRead=true)
 * - If existing article is not read: accept imported read status
 * - If both are read: keep the one with the most recent readDate
 * - If imported article has no readDate: skip it (existing is more reliable)
 * 
 * @param {Object} existing - Existing article from storage
 * @param {Object} imported - Imported article from file
 * @returns {Object|null} Merged article with most recent readDate, or null if should skip
 */
function mergeArticleDataForImport(existing, imported) {
  // Runtime type validation
  if (!existing || typeof existing !== 'object' || Array.isArray(existing)) {
    Logger.warn('mergeArticleDataForImport: existing must be an object', existing);
    return null;
  }
  
  if (!imported || typeof imported !== 'object' || Array.isArray(imported)) {
    Logger.warn('mergeArticleDataForImport: imported must be an object', imported);
    return null;
  }

  // Only import articles that are marked as read
  if (!imported.isRead) {
    return null;
  }

  // If existing article is not read, accept imported read status
  if (!existing.isRead) {
    return {
      url: imported.url,
      title: imported.title || existing.title,
      publishedDate: imported.publishedDate || existing.publishedDate,
      dateText: imported.dateText || existing.dateText,
      isRead: true,
      readDate: imported.readDate
    };
  }

  // Both are read - compare dates to keep most recent
  const importedDate = imported.readDate ? new Date(imported.readDate) : null;
  const existingDate = existing.readDate ? new Date(existing.readDate) : null;

  // If imported doesn't have date, skip it (existing is more reliable)
  if (!importedDate) {
    return null;
  }

  // If imported date is more recent, use it
  if (!existingDate || importedDate > existingDate) {
    return {
      url: imported.url,
      title: imported.title || existing.title,
      publishedDate: imported.publishedDate || existing.publishedDate,
      dateText: imported.dateText || existing.dateText,
      isRead: true,
      readDate: imported.readDate
    };
  }

  // Existing date is more recent, skip import
  return null;
}

/**
 * Validate article object structure
 * @param {*} article - Article to validate
 * @returns {boolean} True if article is valid
 */
function validateArticleStructure(article) {
  if (!article || typeof article !== 'object') {
    return false;
  }
  
  if (!article.url || typeof article.url !== 'string') {
    return false;
  }
  
  // Optional fields should be correct types if present
  if (article.title !== undefined &amp;&amp; typeof article.title !== 'string') {
    return false;
  }
  
  if (article.publishedDate !== undefined &amp;&amp; typeof article.publishedDate !== 'string') {
    return false;
  }
  
  if (article.dateText !== undefined &amp;&amp; typeof article.dateText !== 'string') {
    return false;
  }
  
  if (article.isRead !== undefined &amp;&amp; typeof article.isRead !== 'boolean') {
    return false;
  }
  
  if (article.readDate !== undefined &amp;&amp; article.readDate !== null &amp;&amp; typeof article.readDate !== 'string') {
    return false;
  }
  
  return true;
}

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="PageState.html">PageState</a></li></ul><h3>Global</h3><ul><li><a href="global.html#applyFilter">applyFilter</a></li><li><a href="global.html#attachCheckboxListeners">attachCheckboxListeners</a></li><li><a href="global.html#attachTooltipListeners">attachTooltipListeners</a></li><li><a href="global.html#createCheckbox">createCheckbox</a></li><li><a href="global.html#createExportData">createExportData</a></li><li><a href="global.html#createFilterButton">createFilterButton</a></li><li><a href="global.html#createFilterControl">createFilterControl</a></li><li><a href="global.html#createMutationObserver">createMutationObserver</a></li><li><a href="global.html#createPageStorage">createPageStorage</a></li><li><a href="global.html#createStatusContainer">createStatusContainer</a></li><li><a href="global.html#createStatusIcon">createStatusIcon</a></li><li><a href="global.html#createTooltip">createTooltip</a></li><li><a href="global.html#createTooltipCloseHandler">createTooltipCloseHandler</a></li><li><a href="global.html#createTrackingUI">createTrackingUI</a></li><li><a href="global.html#determineReadStatus">determineReadStatus</a></li><li><a href="global.html#downloadJSON">downloadJSON</a></li><li><a href="global.html#extractArticleFromElement">extractArticleFromElement</a></li><li><a href="global.html#extractArticles">extractArticles</a></li><li><a href="global.html#extractDateFromText">extractDateFromText</a></li><li><a href="global.html#extractLink">extractLink</a></li><li><a href="global.html#extractTime">extractTime</a></li><li><a href="global.html#filterByReadStatus">filterByReadStatus</a></li><li><a href="global.html#findArticleContainer">findArticleContainer</a></li><li><a href="global.html#findArticleElements">findArticleElements</a></li><li><a href="global.html#formatDateFull">formatDateFull</a></li><li><a href="global.html#getArticle">getArticle</a></li><li><a href="global.html#getArticleFromCache">getArticleFromCache</a></li><li><a href="global.html#getArticlesCache">getArticlesCache</a></li><li><a href="global.html#getCurrentDateISO">getCurrentDateISO</a></li><li><a href="global.html#getExistingArticlesMap">getExistingArticlesMap</a></li><li><a href="global.html#getOrCreateArticle">getOrCreateArticle</a></li><li><a href="global.html#getStorageKey">getStorageKey</a></li><li><a href="global.html#handleArticleStatusChange">handleArticleStatusChange</a></li><li><a href="global.html#handleFilterControlPosition">handleFilterControlPosition</a></li><li><a href="global.html#handleTooltipClose">handleTooltipClose</a></li><li><a href="global.html#handleTooltipOpen">handleTooltipOpen</a></li><li><a href="global.html#hasNewArticles">hasNewArticles</a></li><li><a href="global.html#importDataFromFile">importDataFromFile</a></li><li><a href="global.html#injectTrackingUI">injectTrackingUI</a></li><li><a href="global.html#invalidateArticleElementsCache">invalidateArticleElementsCache</a></li><li><a href="global.html#invalidateCache">invalidateCache</a></li><li><a href="global.html#isLethainDomain">isLethainDomain</a></li><li><a href="global.html#isMainPage">isMainPage</a></li><li><a href="global.html#markAsRead">markAsRead</a></li><li><a href="global.html#markAsUnread">markAsUnread</a></li><li><a href="global.html#mergeArticleDataForImport">mergeArticleDataForImport</a></li><li><a href="global.html#mergeArticleState">mergeArticleState</a></li><li><a href="global.html#normalizeUrl">normalizeUrl</a></li><li><a href="global.html#onDOMReady">onDOMReady</a></li><li><a href="global.html#preserveContainerWidth">preserveContainerWidth</a></li><li><a href="global.html#processImportBatch">processImportBatch</a></li><li><a href="global.html#querySelectorWithFallback">querySelectorWithFallback</a></li><li><a href="global.html#scheduleFilterApplication">scheduleFilterApplication</a></li><li><a href="global.html#setResourceManager">setResourceManager</a></li><li><a href="global.html#showAllArticles">showAllArticles</a></li><li><a href="global.html#startObserving">startObserving</a></li><li><a href="global.html#toggleTooltip">toggleTooltip</a></li><li><a href="global.html#updateCacheArticle">updateCacheArticle</a></li><li><a href="global.html#updateLinkStyles">updateLinkStyles</a></li><li><a href="global.html#updateStatusIcon">updateStatusIcon</a></li><li><a href="global.html#updateUIAfterStatusChange">updateUIAfterStatusChange</a></li><li><a href="global.html#validateArticle">validateArticle</a></li><li><a href="global.html#validateArticleStructure">validateArticleStructure</a></li><li><a href="global.html#validateImportData">validateImportData</a></li><li><a href="global.html#validateUrl">validateUrl</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Thu Nov 20 2025 11:45:27 GMT-0300 (Brasilia Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
